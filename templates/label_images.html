<!DOCTYPE html>
<html>
<head>
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='menu.css') }}">
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='selectable.css') }}">
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='toast.css') }}">
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='overlay.css') }}">

<script src="../static/js/jquery-1.12.1.js"></script>
<script src="../static/js/jquery-ui-1.11.4.custom/jquery-ui.js"></script>
<script src="../static/js/jquery.lazyload.js"></script>
<script src="../static/js/context_menu.js"></script>
<script src="../static/js/overlay.js"></script>

<script>
$(document).ready(function() {
  $('#status-select').change(function() {
    var status_select = $(this);
    var state = status_select.val();
    if (state == 'Unannotated') {
      $('#source-select').prop('disabled', true);
      var family_select = $('#family-select');
      var genus_select = $('#genus-select');
      var species_select = $('#species-select');
      // disable the selectors and remove populated options
      family_select.prop('disabled', true);
      genus_select.prop('disabled', true);
      species_select.prop('disabled', true);
      genus_select.find('option').not(':eq(0)').remove();
      species_select.find('option').not(':eq(0)').remove();
    }
    else if (state == 'Annotated') {
      $('#source-select').prop('disabled', false);
      $('#family-select').prop('disabled', false);
    }
    //console.log(state);
  });
  var genus_list;
  $('#family-select').change(function() {
    var family_select = $(this);
    var family_state = family_select.val();
    console.log(family_state);
    var genus_select = $('#genus-select');
    var species_select = $('#species-select');
    species_select.find('option').not(':eq(0)').remove();
    genus_select.find('option').not(':eq(0)').remove();
    if (family_state == 'All') {
      genus_select.prop('disabled', true);
      species_select.prop('disabled', true);
    }
    else if (family_state != 'All') {
      genus_select.prop('disabled', false);
      species_select.prop('disabled', true);
      // remove all but the "All" option
      var families = {{ families|safe }}
      // find the genus list of the selected family
      var family = families.filter(function (obj) {
        return obj.family_name === family_state;
      })[0];
      genus_list = family.genus_list;
      $.each(genus_list, function(i, genus) {
        genus_select.append($('<option>', {
          value: genus.genus_name,
          text: genus.genus_name,
        }));
      });
    }
  });
  $('#genus-select').change(function() {
    var genus_select = $(this);
    var genus_state = genus_select.val();
    var species_select = $('#species-select');
    species_select.find('option').not(':eq(0)').remove();
    if (genus_state == 'All') {
      species_select.prop('disabled', true);
    }
    else if (genus_state != 'All') {
      species_select.prop('disabled', false);
      var genus = genus_list.filter(function (obj) {
        return obj.genus_name === genus_state;
      })[0];
      console.log(genus_state);
      var species_list = genus.species_list;
      $.each(species_list, function(i, species) {
        species_select.append($('<option>', {
          value: species.species_name,
          text: species.species_name,
        }));
      });
    }
  });
});
$(document).ready(function() {
  $('#begin').click(function() {
    var limit = $('#limit-input').val();
    var select_status = $('#status-select').val();
    var select_source = $('#source-select').val();
    var select_family = $('#family-select').val();
    var select_genus = $('#genus-select').val();
    var select_species = $('#species-select').val();

    $.ajax({
      url: '/label',
      data: jQuery.param({
        'limit': limit,
        'status': select_status,
        'source': select_source,
        'family': select_family,
        'genus': select_genus,
        'species': select_species,
      }),
      type: 'POST',
      success: function(response) {
        //console.log('success: ' + response);
        var images = JSON.parse(response);
        var selectable = $('#selectable');
        selectable.empty();  // clear before we re-populate the view
        for (var i = 0; i < images.length; i++) {
          var figure = jQuery('<figure/>', {
            'class': 'selectable-figure',
          }).appendTo(selectable);
          var img = jQuery('<img/>', {
            'id': images[i].image_id,
            'class': 'lazy',
            'data-original': images[i].image_filepath,
            'width': images[i].width,
            'height': images[i].height,
            }).appendTo(figure);

          // display the most specific known classification for this image
          var caption;
          if (images[i].species_name != "None")
            caption = images[i].species_name;
          else if (images[i].genus_name != "None")
            caption = images[i].genus_name;
          else
            caption = images[i].family_name;

          var figcaption = jQuery('<figcaption/>', {
            'html': caption,
          }).appendTo(figure);
          img.lazyload();
        }
        //$('img.lazy').lazyload();
      },
      error: function(error) {
        console.log('error ' + error);
      }
    });
  });
});
//$(document).ready(function () {
// var selectable = document.getElementById('selectable');
// var images = {{ images|safe }};
// for (i = 0; i < images.length; i++) {
//   var image = JSON.parse(images[i]);
//   var elem = document.createElement('img');
//   //elem.setAttribute("id", "img");
//   elem.setAttribute("class", "lazy");
//   elem.setAttribute("data-original", image['src']);
//   elem.setAttribute("width", image['width']);
//   elem.setAttribute("height", image['height']);
//   selectable.appendChild(elem);
// }
//});
$(document).ready(function() {
    $('img.lazy').lazyload();
});
$(document).ready(function() {
    // set refresh to true if image selection breaks...
    // eventually we need a better way to handle the selection for 100,000+ images
  // setting autoRefresh to true allows the images to be added dynamically
    $('#selectable').selectable({autoRefresh: true, filter: 'figure.selectable-figure'});
});
</script>
</head>

{% extends "layout.html" %}
{% block body %}
<section id="filter">
  <div id="status">
    Status:
    <p>
      <select id="status-select">
        <option>Unannotated</option>
        <option>Annotated</option>
      </select>
    </p>
  </div>
  <div id="source">
    Source:
    <p>
      <select id="source-select" disabled="true">
        <option>Algorithm</option>
        <option>Human</option>
      </select>
    </p>
  </div>
  <div id="families">
    Families:
    <p>
      <select id="family-select" disabled="true">
        <option>All</option>
        {% for family in families %}
          <option>{{ family.family_name }}</option>
        {% endfor %}
      </select>
    </p>
  </div>
  <div id="genera">
    Genera:
    <p>
      <select id="genus-select" disabled="true">
        <option>All</option>
      </select>
    </p>
  </div>
  <div id="species">
    Species:
    <p>
      <select id="species-select" disabled="true">
        <option>All</option>
      </select>
    </p>
  </div>
  <div id="limit">
    Limit to:
    <p>
      <input id="limit-input" class="input" type="number" value="100"></input>
    </p>
  </div>
  <div id="begin">
    <button>Begin labeling!</button>
  </div>
</section>

<div id="overlay"></div>
<div id="overlayContent">
  <img id="overlayImage" src="" alt=""/>
  <div id="overlay_image_filepath" class="overlay_info"></div>
  <div id="overlay_image_date_collected" class="overlay_info"></div>
  <div id="overlay_image_species" class="overlay_info"></div>
  <div id="overlay_image_confusable" class="overlay_info"></div>
  <div id="overlay_image_added" class="overlay_info"></div>
  <div id="overlay_image_annotated" class="overlay_info"></div>
  <div id="overlay_image_dimensions" class="overlay_info"></div>
</div>
<div class='toast' style='display:none'></div>

<ul id="family-menu" class="drop">
  <span>Family</span>
  {% for family in families %}
      <li id="{{ family.family_id }}" data-action="{{ family.family_name }}">{{ family.family_name }}
        <ul id="genus-menu" class="drop">
        <span>Genus</span>
        {% for genus in family.genus_list %}
          <li id="{{ genus.genus_id }}" data-action="{{ genus.genus_name }}">{{ genus.genus_name }}
              <ul id="species-menu" class="drop">
                <span>Species</span>
                {% for sp in genus.species_list %}
                <li id="{{ sp.species_id }}" data-action="{{ sp.species_name }}">{{ sp.species_name }}
                </li>
                {% endfor %}
              </ul>
          </li>
        {% endfor %}
        </ul>
      </li>
  {% endfor %}
</ul> 

<ul id="selectable">
  <!--
  {% for image in images %}
  <figure class="selectable-figure">
    <img id="{{ image.image_id }}" class="lazy" data-original="{{ image.src }}" width="{{ image.width }}" height="{{ image.height }}" />
    <figcaption>{{ image.species }}</figcaption>
  </figure>
  {% endfor %}
  -->
</ul>

{% endblock %}
</html>
